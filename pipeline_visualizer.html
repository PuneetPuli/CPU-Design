<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIPS Pipeline Visualizer</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #4CAF50;
            margin-bottom: 30px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-size: 12px;
            color: #ccc;
        }
        
        input, select, button {
            padding: 8px 12px;
            border: 1px solid #555;
            background: #333;
            color: #fff;
            border-radius: 4px;
        }
        
        button {
            background: #4CAF50;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .pipeline {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }
        
        .stage {
            flex: 1;
            max-width: 200px;
            min-height: 400px;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 15px;
            background: #2a2a2a;
            position: relative;
        }
        
        .stage-header {
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            padding: 8px;
            background: #444;
            border-radius: 4px;
        }
        
        .if { border-color: #FF6B6B; }
        .id { border-color: #4ECDC4; }
        .ex { border-color: #45B7D1; }
        .mem { border-color: #96CEB4; }
        .wb { border-color: #FFEAA7; }
        
        .instruction {
            background: #444;
            border: 1px solid #666;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .instruction.active {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }
        
        .instruction.stall {
            background: #8B4513;
            border-color: #CD853F;
        }
        
        .instruction.nop {
            background: #555;
            opacity: 0.6;
        }
        
        .instr-text {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .instr-details {
            font-size: 11px;
            color: #ccc;
            line-height: 1.3;
        }
        
        .cycle-info {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #4CAF50;
        }
        
        .registers {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            margin-bottom: 20px;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        
        .register {
            padding: 5px;
            background: #444;
            border-radius: 4px;
            text-align: center;
            font-size: 11px;
        }
        
        .register.modified {
            background: #4CAF50;
            animation: flash 0.5s;
        }
        
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .memory {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .memory-cell {
            padding: 5px;
            background: #444;
            border-radius: 4px;
            text-align: center;
            font-size: 11px;
        }
        
        .memory-cell.accessed {
            background: #FF6B6B;
            animation: flash 0.5s;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-box {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #555;
        }
        
        .stat-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #4CAF50;
        }
        
        .forwarding-path {
            position: absolute;
            border: 2px dashed #FFD700;
            z-index: 10;
            animation: dash 1s linear infinite;
        }
        
        @keyframes dash {
            to { stroke-dashoffset: -10; }
        }
        
        .hazard-indicator {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #FF4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ MIPS 5-Stage Pipeline Visualizer</h1>
        
        <div class="controls">
            <div class="control-group">
                <label>Sample Program:</label>
                <select id="programSelect">
                    <option value="simple">Simple Add/Load</option>
                    <option value="hazard">Data Hazard Example</option>
                    <option value="branch">Branch Example</option>
                    <option value="custom">Custom Program</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Speed (ms):</label>
                <input type="range" id="speedSlider" min="100" max="2000" value="800">
                <span id="speedValue">800ms</span>
            </div>
            
            <button id="stepBtn">Step</button>
            <button id="playBtn">Play</button>
            <button id="pauseBtn">Pause</button>
            <button id="resetBtn">Reset</button>
        </div>
        
        <div class="cycle-info">
            Cycle: <span id="cycleCount">0</span>
        </div>
        
        <div class="pipeline">
            <div class="stage if">
                <div class="stage-header">IF</div>
                <div class="stage-content" id="if-content">
                    <div class="instr-details">PC: <span id="pc-value">0</span></div>
                </div>
            </div>
            
            <div class="stage id">
                <div class="stage-header">ID</div>
                <div class="stage-content" id="id-content"></div>
            </div>
            
            <div class="stage ex">
                <div class="stage-header">EX</div>
                <div class="stage-content" id="ex-content"></div>
            </div>
            
            <div class="stage mem">
                <div class="stage-header">MEM</div>
                <div class="stage-content" id="mem-content"></div>
            </div>
            
            <div class="stage wb">
                <div class="stage-header">WB</div>
                <div class="stage-content" id="wb-content"></div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-box">
                <div class="stat-title">Registers</div>
                <div class="registers" id="registers"></div>
            </div>
            
            <div class="stat-box">
                <div class="stat-title">Data Memory</div>
                <div class="memory" id="memory"></div>
            </div>
            
            <div class="stat-box">
                <div class="stat-title">Pipeline Stats</div>
                <div id="pipeline-stats">
                    <div>Instructions Completed: <span id="instr-completed">0</span></div>
                    <div>Stalls: <span id="stall-count">0</span></div>
                    <div>Forwards: <span id="forward-count">0</span></div>
                    <div>CPI: <span id="cpi">1.00</span></div>
                </div>
            </div>
        </div>
        
        <div class="stat-box" style="margin-top: 20px;">
            <div class="stat-title">Custom Program (Hex Instructions)</div>
            <textarea id="customProgram" rows="5" style="width: 100%; background: #333; color: #fff; border: 1px solid #555; padding: 10px;">
20020005
20030003
00431020
ac220000
8c240000
10000001
00000000
</textarea>
        </div>
    </div>

    <script>
        class PipelineSimulator {
            constructor() {
                this.cycle = 0;
                this.pc = 0;
                this.registers = new Array(32).fill(0);
                this.memory = new Array(16).fill(0);
                this.pipeline = {
                    IF: null,
                    ID: null,
                    EX: null,
                    MEM: null,
                    WB: null
                };
                this.program = [];
                this.isRunning = false;
                this.intervalId = null;
                this.stats = {
                    completed: 0,
                    stalls: 0,
                    forwards: 0
                };
                
                // Wait for DOM to be ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        this.initializeUI();
                        this.loadProgram('simple');
                    });
                } else {
                    this.initializeUI();
                    this.loadProgram('simple');
                }
            }
            
            initializeUI() {
                // Initialize registers display
                const regContainer = document.getElementById('registers');
                for (let i = 0; i < 32; i++) {
                    const regDiv = document.createElement('div');
                    regDiv.className = 'register';
                    regDiv.id = `reg-${i}`;
                    regDiv.innerHTML = `$${i}<br>0`;
                    regContainer.appendChild(regDiv);
                }
                
                // Initialize memory display
                const memContainer = document.getElementById('memory');
                for (let i = 0; i < 16; i++) {
                    const memDiv = document.createElement('div');
                    memDiv.className = 'memory-cell';
                    memDiv.id = `mem-${i}`;
                    memDiv.innerHTML = `[${i}]<br>0`;
                    memContainer.appendChild(memDiv);
                }
                
                this.updateDisplay();
            }
            
            loadProgram(type) {
                const programs = {
                    simple: [
                        { hex: 0x20020005, asm: 'addi $2, $0, 5', desc: 'Load 5 into $2' },
                        { hex: 0x20030003, asm: 'addi $3, $0, 3', desc: 'Load 3 into $3' },
                        { hex: 0x00431020, asm: 'add $2, $2, $3', desc: 'Add $2 + $3 -> $2' },
                        { hex: 0xac220000, asm: 'sw $2, 0($1)', desc: 'Store $2 to mem[0]' },
                        { hex: 0x00000000, asm: 'nop', desc: 'No operation' }
                    ],
                    hazard: [
                        { hex: 0x8c220000, asm: 'lw $2, 0($1)', desc: 'Load from mem[0]' },
                        { hex: 0x00421020, asm: 'add $2, $2, $2', desc: 'Use $2 (hazard!)' },
                        { hex: 0x20030001, asm: 'addi $3, $0, 1', desc: 'Load 1 into $3' },
                        { hex: 0x00000000, asm: 'nop', desc: 'No operation' }
                    ],
                    branch: [
                        { hex: 0x20020005, asm: 'addi $2, $0, 5', desc: 'Load 5 into $2' },
                        { hex: 0x10400002, asm: 'beq $2, $0, 2', desc: 'Branch if $2 == 0' },
                        { hex: 0x20020000, asm: 'addi $2, $0, 0', desc: 'Clear $2' },
                        { hex: 0x20030001, asm: 'addi $3, $0, 1', desc: 'Load 1 into $3' },
                        { hex: 0x00000000, asm: 'nop', desc: 'No operation' }
                    ]
                };
                
                if (type === 'custom') {
                    const customText = document.getElementById('customProgram').value;
                    const lines = customText.trim().split('\n');
                    this.program = lines.map(line => {
                        const hex = parseInt(line.trim(), 16);
                        return { hex, asm: this.disassemble(hex), desc: 'Custom instruction' };
                    });
                } else {
                    this.program = programs[type] || programs.simple;
                }
                
                this.reset();
            }
            
            disassemble(instr) {
                const opcode = (instr >> 26) & 0x3F;
                const rs = (instr >> 21) & 0x1F;
                const rt = (instr >> 16) & 0x1F;
                const rd = (instr >> 11) & 0x1F;
                const imm = instr & 0xFFFF;
                const func = instr & 0x3F;
                
                switch (opcode) {
                    case 0x08: return `addi $${rt}, $${rs}, ${imm}`;
                    case 0x23: return `lw $${rt}, ${imm}($${rs})`;
                    case 0x2B: return `sw $${rt}, ${imm}($${rs})`;
                    case 0x04: return `beq $${rs}, $${rt}, ${imm}`;
                    case 0x00:
                        switch (func) {
                            case 0x20: return `add $${rd}, $${rs}, $${rt}`;
                            case 0x22: return `sub $${rd}, $${rs}, $${rt}`;
                            case 0x24: return `and $${rd}, $${rs}, $${rt}`;
                            case 0x25: return `or $${rd}, $${rs}, $${rt}`;
                            default: return 'nop';
                        }
                    default: return 'unknown';
                }
            }
            
            step() {
                console.log(`=== CYCLE ${this.cycle + 1} ===`);
                this.cycle++;
                
                // Simulate pipeline stages (simplified)
                const newPipeline = { ...this.pipeline };
                
                // WB stage
                if (this.pipeline.WB) {
                    console.log('WB stage:', this.pipeline.WB.asm);
                    this.executeWB(this.pipeline.WB);
                    this.stats.completed++;
                }
                newPipeline.WB = this.pipeline.MEM;
                
                // MEM stage
                if (this.pipeline.MEM) {
                    console.log('MEM stage:', this.pipeline.MEM.asm);
                    this.executeMEM(this.pipeline.MEM);
                }
                newPipeline.MEM = this.pipeline.EX;
                
                // EX stage
                if (this.pipeline.EX) {
                    console.log('EX stage:', this.pipeline.EX.asm);
                    this.executeEX(this.pipeline.EX);
                }
                newPipeline.EX = this.pipeline.ID;
                
                // ID stage
                if (this.pipeline.ID) {
                    console.log('ID stage:', this.pipeline.ID.asm);
                    this.executeID(this.pipeline.ID);
                }
                newPipeline.ID = this.pipeline.IF;
                
                // IF stage
                const instrIndex = Math.floor(this.pc / 4);
                if (instrIndex < this.program.length) {
                    newPipeline.IF = {
                        ...this.program[instrIndex],
                        pc: this.pc
                    };
                    console.log('IF stage: fetching', newPipeline.IF.asm, 'at PC', this.pc);
                    this.pc += 4;
                } else {
                    newPipeline.IF = null;
                    console.log('IF stage: no more instructions');
                }
                
                this.pipeline = newPipeline;
                this.updateDisplay();
                
                // Check if pipeline is empty
                if (!this.pipeline.IF && !this.pipeline.ID && !this.pipeline.EX && 
                    !this.pipeline.MEM && !this.pipeline.WB) {
                    console.log('Pipeline empty, stopping');
                    this.pause();
                }
            }
            
            executeWB(instr) {
                try {
                    // Simplified writeback simulation
                    const opcode = (instr.hex >> 26) & 0x3F;
                    const rt = (instr.hex >> 16) & 0x1F;
                    const rd = (instr.hex >> 11) & 0x1F;
                    const rs = (instr.hex >> 21) & 0x1F;
                    
                    console.log(`WB: opcode=${opcode}, rs=${rs}, rt=${rt}, rd=${rd}`);
                    
                    if (opcode === 0x08 && rt !== 0) { // addi
                        const imm = instr.hex & 0xFFFF;
                        // Sign extend immediate
                        const signExtImm = imm & 0x8000 ? imm - 0x10000 : imm;
                        this.registers[rt] = (this.registers[rs] + signExtImm) & 0xFFFFFFFF;
                        this.highlightRegister(rt);
                        console.log(`ADDI: $${rt} = $${rs}(${this.registers[rs]}) + ${signExtImm} = ${this.registers[rt]}`);
                    } else if (opcode === 0x23 && rt !== 0) { // lw
                        const imm = instr.hex & 0xFFFF;
                        const signExtImm = imm & 0x8000 ? imm - 0x10000 : imm;
                        const addr = Math.floor((this.registers[rs] + signExtImm) / 4);
                        if (addr >= 0 && addr < this.memory.length) {
                            this.registers[rt] = this.memory[addr];
                            this.highlightRegister(rt);
                            console.log(`LW: $${rt} = mem[${addr}] = ${this.registers[rt]}`);
                        }
                    } else if (opcode === 0x00 && rd !== 0) { // R-type
                        const func = instr.hex & 0x3F;
                        
                        if (func === 0x20) { // add
                            this.registers[rd] = (this.registers[rs] + this.registers[rt]) & 0xFFFFFFFF;
                            this.highlightRegister(rd);
                            console.log(`ADD: $${rd} = $${rs}(${this.registers[rs]}) + $${rt}(${this.registers[rt]}) = ${this.registers[rd]}`);
                        }
                    }
                } catch (e) {
                    console.error('Error in executeWB:', e);
                }
            }
            
            executeMEM(instr) {
                try {
                    const opcode = (instr.hex >> 26) & 0x3F;
                    if (opcode === 0x2B) { // sw
                        const rs = (instr.hex >> 21) & 0x1F;
                        const rt = (instr.hex >> 16) & 0x1F;
                        const imm = instr.hex & 0xFFFF;
                        const signExtImm = imm & 0x8000 ? imm - 0x10000 : imm;
                        const addr = Math.floor((this.registers[rs] + signExtImm) / 4);
                        if (addr >= 0 && addr < this.memory.length) {
                            this.memory[addr] = this.registers[rt];
                            this.highlightMemory(addr);
                            console.log(`SW: mem[${addr}] = $${rt}(${this.registers[rt]})`);
                        }
                    }
                } catch (e) {
                    console.error('Error in executeMEM:', e);
                }
            }
            
            executeEX(instr) {
                // Execution stage - ALU operations happen here
            }
            
            executeID(instr) {
                // Instruction decode - register reads happen here
            }
            
            highlightRegister(reg) {
                const regElement = document.getElementById(`reg-${reg}`);
                regElement.classList.add('modified');
                regElement.innerHTML = `$${reg}<br>${this.registers[reg]}`;
                setTimeout(() => regElement.classList.remove('modified'), 500);
            }
            
            highlightMemory(addr) {
                const memElement = document.getElementById(`mem-${addr}`);
                memElement.classList.add('accessed');
                memElement.innerHTML = `[${addr}]<br>${this.memory[addr]}`;
                setTimeout(() => memElement.classList.remove('accessed'), 500);
            }
            
            updateDisplay() {
                // Update cycle counter
                document.getElementById('cycleCount').textContent = this.cycle;
                document.getElementById('pc-value').textContent = this.pc;
                
                // Update pipeline stages
                this.updateStage('if', this.pipeline.IF);
                this.updateStage('id', this.pipeline.ID);
                this.updateStage('ex', this.pipeline.EX);
                this.updateStage('mem', this.pipeline.MEM);
                this.updateStage('wb', this.pipeline.WB);
                
                // Update stats
                document.getElementById('instr-completed').textContent = this.stats.completed;
                document.getElementById('stall-count').textContent = this.stats.stalls;
                document.getElementById('forward-count').textContent = this.stats.forwards;
                document.getElementById('cpi').textContent = this.cycle > 0 ? (this.cycle / Math.max(this.stats.completed, 1)).toFixed(2) : '1.00';
            }
            
            updateStage(stageId, instr) {
                const container = document.getElementById(`${stageId}-content`);
                container.innerHTML = '';
                
                if (instr) {
                    const instrDiv = document.createElement('div');
                    instrDiv.className = 'instruction active';
                    instrDiv.innerHTML = `
                        <div class="instr-text">${instr.asm}</div>
                        <div class="instr-details">${instr.desc}</div>
                        <div class="instr-details">Hex: 0x${instr.hex.toString(16).padStart(8, '0')}</div>
                    `;
                    container.appendChild(instrDiv);
                }
            }
            
            play() {
                if (this.isRunning) return;
                this.isRunning = true;
                const speed = parseInt(document.getElementById('speedSlider').value);
                
                this.intervalId = setInterval(() => {
                    if (this.isRunning) {
                        this.step();
                    } else {
                        clearInterval(this.intervalId);
                    }
                }, speed);
            }
            
            pause() {
                this.isRunning = false;
                if (this.intervalId) {
                    clearInterval(this.intervalId);
                    this.intervalId = null;
                }
            }
            
            reset() {
                this.cycle = 0;
                this.pc = 0;
                this.registers.fill(0);
                this.memory.fill(0);
                this.pipeline = { IF: null, ID: null, EX: null, MEM: null, WB: null };
                this.stats = { completed: 0, stalls: 0, forwards: 0 };
                this.pause();
                this.updateDisplay();
                
                // Reset register display
                for (let i = 0; i < 32; i++) {
                    const regElement = document.getElementById(`reg-${i}`);
                    regElement.innerHTML = `$${i}<br>0`;
                    regElement.classList.remove('modified');
                }
                
                // Reset memory display
                for (let i = 0; i < 16; i++) {
                    const memElement = document.getElementById(`mem-${i}`);
                    memElement.innerHTML = `[${i}]<br>0`;
                    memElement.classList.remove('accessed');
                }
            }
        }
        
        // Initialize simulator when page loads
        let simulator;
        
        function initializeApp() {
            simulator = new PipelineSimulator();
            
            // Event listeners
            document.getElementById('stepBtn').addEventListener('click', () => {
                console.log('Step clicked');
                simulator.step();
            });
            
            document.getElementById('playBtn').addEventListener('click', () => {
                console.log('Play clicked');
                simulator.play();
            });
            
            document.getElementById('pauseBtn').addEventListener('click', () => {
                console.log('Pause clicked');
                simulator.pause();
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                console.log('Reset clicked');
                simulator.reset();
            });
            
            document.getElementById('programSelect').addEventListener('change', (e) => {
                console.log('Program changed to:', e.target.value);
                simulator.loadProgram(e.target.value);
            });
            
            document.getElementById('speedSlider').addEventListener('input', (e) => {
                document.getElementById('speedValue').textContent = e.target.value + 'ms';
            });
            
            document.getElementById('customProgram').addEventListener('change', () => {
                if (document.getElementById('programSelect').value === 'custom') {
                    simulator.loadProgram('custom');
                }
            });
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>