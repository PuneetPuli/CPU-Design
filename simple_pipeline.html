<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple MIPS Pipeline Visualizer</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        
        .controls {
            margin-bottom: 20px;
        }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        .pipeline {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        
        .stage {
            flex: 1;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 15px;
            background: #2a2a2a;
            min-height: 200px;
        }
        
        .stage h3 {
            margin: 0 0 15px 0;
            text-align: center;
            color: #4CAF50;
        }
        
        .instruction {
            background: #444;
            border: 1px solid #666;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
        }
        
        .instruction.active {
            background: #4CAF50;
            color: black;
        }
        
        .cycle-info {
            font-size: 24px;
            text-align: center;
            margin: 20px 0;
            color: #4CAF50;
        }
        
        .registers {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            margin: 20px 0;
        }
        
        .register {
            background: #333;
            padding: 5px;
            text-align: center;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .register.changed {
            background: #4CAF50;
            color: black;
        }
    </style>
</head>
<body>
    <h1>ðŸš€ Simple MIPS Pipeline Visualizer</h1>
    
    <div class="controls">
        <button onclick="step()">Step</button>
        <button onclick="play()">Play</button>
        <button onclick="pause()">Pause</button>
        <button onclick="reset()">Reset</button>
    </div>
    
    <div class="cycle-info">
        Cycle: <span id="cycle">0</span>
    </div>
    
    <div class="pipeline">
        <div class="stage">
            <h3>IF</h3>
            <div id="if-stage">
                <div>PC: <span id="pc">0</span></div>
            </div>
        </div>
        
        <div class="stage">
            <h3>ID</h3>
            <div id="id-stage"></div>
        </div>
        
        <div class="stage">
            <h3>EX</h3>
            <div id="ex-stage"></div>
        </div>
        
        <div class="stage">
            <h3>MEM</h3>
            <div id="mem-stage"></div>
        </div>
        
        <div class="stage">
            <h3>WB</h3>
            <div id="wb-stage"></div>
        </div>
    </div>
    
    <div>
        <h3>Registers</h3>
        <div class="registers" id="registers"></div>
    </div>

    <script>
        // Global variables
        let cycle = 0;
        let pc = 0;
        let registers = new Array(32).fill(0);
        let isRunning = false;
        let intervalId = null;
        
        // Sample program
        const program = [
            { hex: 0x20020005, asm: 'addi $2, $0, 5', desc: 'Load 5 into $2' },
            { hex: 0x20030003, asm: 'addi $3, $0, 3', desc: 'Load 3 into $3' },
            { hex: 0x00431020, asm: 'add $2, $2, $3', desc: 'Add $2 + $3 -> $2' },
            { hex: 0xac220000, asm: 'sw $2, 0($1)', desc: 'Store $2 to mem[0]' },
            { hex: 0x00000000, asm: 'nop', desc: 'No operation' }
        ];
        
        // Pipeline state
        let pipeline = {
            IF: null,
            ID: null,
            EX: null,
            MEM: null,
            WB: null
        };
        
        function init() {
            console.log('Initializing...');
            
            // Initialize registers display
            const regContainer = document.getElementById('registers');
            for (let i = 0; i < 32; i++) {
                const regDiv = document.createElement('div');
                regDiv.className = 'register';
                regDiv.id = `reg-${i}`;
                regDiv.textContent = `$${i}: 0`;
                regContainer.appendChild(regDiv);
            }
            
            updateDisplay();
            console.log('Initialization complete');
        }
        
        function step() {
            console.log('Step button clicked!');
            cycle++;
            
            // Move instructions through pipeline
            const newPipeline = {};
            
            // WB stage
            if (pipeline.WB) {
                executeWB(pipeline.WB);
            }
            newPipeline.WB = pipeline.MEM;
            
            // MEM stage
            newPipeline.MEM = pipeline.EX;
            
            // EX stage
            newPipeline.EX = pipeline.ID;
            
            // ID stage
            newPipeline.ID = pipeline.IF;
            
            // IF stage
            const instrIndex = Math.floor(pc / 4);
            if (instrIndex < program.length) {
                newPipeline.IF = program[instrIndex];
                pc += 4;
            } else {
                newPipeline.IF = null;
            }
            
            pipeline = newPipeline;
            updateDisplay();
            
            console.log('Step completed, cycle:', cycle);
        }
        
        function executeWB(instr) {
            if (!instr) return;
            
            const opcode = (instr.hex >> 26) & 0x3F;
            const rt = (instr.hex >> 16) & 0x1F;
            const rs = (instr.hex >> 21) & 0x1F;
            
            if (opcode === 0x08 && rt !== 0) { // addi
                const imm = instr.hex & 0xFFFF;
                const signExtImm = imm & 0x8000 ? imm - 0x10000 : imm;
                registers[rt] = registers[rs] + signExtImm;
                highlightRegister(rt);
                console.log(`ADDI: $${rt} = ${registers[rt]}`);
            }
        }
        
        function highlightRegister(reg) {
            const regElement = document.getElementById(`reg-${reg}`);
            if (regElement) {
                regElement.classList.add('changed');
                regElement.textContent = `$${reg}: ${registers[reg]}`;
                setTimeout(() => regElement.classList.remove('changed'), 1000);
            }
        }
        
        function updateDisplay() {
            // Update cycle
            document.getElementById('cycle').textContent = cycle;
            document.getElementById('pc').textContent = pc;
            
            // Update pipeline stages
            updateStage('if-stage', pipeline.IF);
            updateStage('id-stage', pipeline.ID);
            updateStage('ex-stage', pipeline.EX);
            updateStage('mem-stage', pipeline.MEM);
            updateStage('wb-stage', pipeline.WB);
        }
        
        function updateStage(stageId, instr) {
            const container = document.getElementById(stageId);
            if (stageId === 'if-stage') {
                // IF stage has special content
                const pcSpan = container.querySelector('#pc');
                if (pcSpan) pcSpan.textContent = pc;
                
                if (instr) {
                    let instrDiv = container.querySelector('.instruction');
                    if (!instrDiv) {
                        instrDiv = document.createElement('div');
                        instrDiv.className = 'instruction';
                        container.appendChild(instrDiv);
                    }
                    instrDiv.innerHTML = `<strong>${instr.asm}</strong><br><small>${instr.desc}</small>`;
                    instrDiv.classList.add('active');
                } else {
                    const instrDiv = container.querySelector('.instruction');
                    if (instrDiv) {
                        instrDiv.remove();
                    }
                }
            } else {
                // Other stages
                container.innerHTML = '';
                if (instr) {
                    const instrDiv = document.createElement('div');
                    instrDiv.className = 'instruction active';
                    instrDiv.innerHTML = `<strong>${instr.asm}</strong><br><small>${instr.desc}</small>`;
                    container.appendChild(instrDiv);
                }
            }
        }
        
        function play() {
            console.log('Play button clicked!');
            if (isRunning) return;
            
            isRunning = true;
            intervalId = setInterval(() => {
                step();
                
                // Stop if pipeline is empty
                if (!pipeline.IF && !pipeline.ID && !pipeline.EX && !pipeline.MEM && !pipeline.WB) {
                    pause();
                }
            }, 1000);
        }
        
        function pause() {
            console.log('Pause button clicked!');
            isRunning = false;
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }
        
        function reset() {
            console.log('Reset button clicked!');
            pause();
            cycle = 0;
            pc = 0;
            registers.fill(0);
            pipeline = { IF: null, ID: null, EX: null, MEM: null, WB: null };
            
            // Reset register display
            for (let i = 0; i < 32; i++) {
                const regElement = document.getElementById(`reg-${i}`);
                if (regElement) {
                    regElement.textContent = `$${i}: 0`;
                    regElement.classList.remove('changed');
                }
            }
            
            updateDisplay();
        }
        
        // Initialize when page loads
        window.addEventListener('load', init);
        
        // Test that JavaScript is working
        console.log('JavaScript loaded successfully!');
    </script>
</body>
</html>